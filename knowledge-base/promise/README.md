# Promise相关知识

## 事件循环
事件循环是JavaScript中的一种机制，负责管理异步任务。  
JavaScript是一种单线程语言，这意味着它只能执行一段代码。  
然而，由于事件循环，JavaScript可以给我们多线程的错觉，即同时处理多个任务不阻塞主线程。

### 调用栈
它是一种跟踪程序执行上下文的数据结构，当您调用一个JavaScript函数时,它会作为一个框架添加到调用堆栈中。该函数返回后将从调用堆栈中删除。  
调用堆栈是LIFO（Last In, First Out）后进先出数据结构。

### 队列
事件队列负责将新函数分派到堆栈中执行，它使用队列数据结构来跟踪所有操作发送执行的顺序。

### Web API
它是一个浏览器组件，用于管理定时器和网络请求等异步操作。当异步操作完成时，它将被传递到Web API，例如，当接口接口请求完成后，Web API会像队列添加回调函数。

### 事件循环是如何工作的
事件循环是在JavaScript程序的后台运行的连续过程。运行程序时，首先调用堆栈，从堆栈顶部开始执行。函数是随着程序的执行而从调用堆栈中添加和撤回的，程序以有序的方式刘晶不同的函数。

当执行遇到异步任务时，如定时器等，程序不会等待任务执行完成后再继续执行下一行代码。相反，操作会被发送到Web API，后者在自己的线程中处理它，每当任务完成时，回调函数就会添加到回调队列中。

事件循环会不断地扫描回调队列，若是在队列中找到回调函数，则会将其添加到调用堆栈中并执行。重复此过程，直到回调队列为空。

### 任务执行

在事件循环过程中，JavaScript引擎接收任务，执行它们，然后休眠，等待更多的任务。

JavaScript引擎大多数时候不执行任务操作，它仅在脚本、处理程序、事件激活时运行。

任务示例：
- 当外部脚本`<script src=''>`加载时，任务就是执行它。
- 当用户移动鼠标是，任务就是调用`mousemove`事件并执行处理程序。
- 当计划的时间到期时`setTimeout`，任务是运行其回调。
- ...等等。

在这个过程中，可能会发生任务在引擎繁忙时到来，然后将其排队。

当任务形成一个队列，即称为所谓的“宏任务队列”（V8术语）。

队列中的人物按照“先到先服务”的原则进行处理。  

细节：
- 当引擎执行任务时，渲染永远不会发生。
- 如果某项任务花费的时间太长，浏览器就无法执行其他任务。因此，一段时间后，浏览器会发出”页面无响应“之类的警报。

上面描述了”宏任务“的由来，而微任务是什么呢，微任务完全来自我们的代码，它通常由Promise来创建。
还有一个特殊的函数queueMicrotask(func)。

**在每个宏任务之后，引擎会立即执行微任务队列中的所有任务，然后在运行任何其他宏任务或渲染或其他任务**

所有微任务都在任何其他事件处理或渲染或任何其他宏任务发生之前完成。

如果我们想异步执行一个函数（在当前代码之后），但在渲染更改或处理新事件之前，我们可以使用queueMicrotask.

事件循环执行步骤：
- 从宏任务队列中出列并运行最先入栈的任务。
- 执行所有微任务
  - 当微任务队列不为空时：
    - 将最先入栈的微任务出列并运行
- 渲染更改（若有dom操作）
- 如果宏任务队列为空，则等待宏任务出现
- 转到步骤1

> 对于不应阻塞事件循环的长时间繁重计算，我们可以使用Web Workers。
这是在另一个并行线程中运行代码的一种方法。
Web Workers 可以与主进程交换消息，但它们有自己的变量和事件循环。
Web Workers 无法访问 DOM，因此它们主要用于计算、同时使用多个 CPU 核心。

### 参考来源
[外网-事件循环](https://medium.com/geekculture/the-event-loop-explained-a-comprehensive-guide-to-asynchronous-javascript-5dd4e43cd315)
[外网-宏任务微任务](https://javascript.info/event-loop)




## 题目参考来源
- [掘金-【建议星星】要就来45道Promise面试题一次爽到底(1.1w字用心整理)](https://juejin.cn/post/6844904077537574919)